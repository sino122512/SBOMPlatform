<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SBOM 原型平台</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h1>SBOM 原型平台</h1>
    <!-- 目录扫描表单 -->
    <h3>通过目录扫描生成 SBOM</h3>
    <form id="dirForm">
        <div class="mb-3">
            <label for="dirName" class="form-label">项目名称</label>
            <input type="text" class="form-control" id="dirName" name="name" required>
        </div>
        <div class="mb-3">
            <label for="dirFormat" class="form-label">输出格式</label>
            <select class="form-select" id="dirFormat" name="format">
                <option value="cyclonedx-json" selected>CycloneDX JSON</option>
                <option value="spdx-json">SPDX JSON</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="dirPath" class="form-label">扫描目录路径</label>
            <input type="text" class="form-control" id="dirPath" name="path" placeholder="例如 data/scan" required>
        </div>
        <button type="submit" class="btn btn-primary">生成目录扫描 SBOM</button>
    </form>
    <hr>
    <!-- 镜像扫描表单 -->
    <h3>通过容器镜像生成 SBOM</h3>
    <form id="imageForm">
        <div class="mb-3">
            <label for="imageName" class="form-label">镜像名称</label>
            <input type="text" class="form-control" id="imageName" name="imageName" placeholder="例如 ubuntu:latest" required>
        </div>
        <div class="mb-3">
            <label for="imageProjectName" class="form-label">项目名称</label>
            <input type="text" class="form-control" id="imageProjectName" name="name" required>
        </div>
        <div class="mb-3">
            <label for="imageFormat" class="form-label">输出格式</label>
            <select class="form-select" id="imageFormat" name="format">
                <option value="cyclonedx-json" selected>CycloneDX JSON</option>
                <option value="spdx-json">SPDX JSON</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">生成镜像扫描 SBOM</button>
    </form>
    <hr>
    <h2>SBOM 列表</h2>
    <div id="sbomList">
        <!-- AJAX 加载 SBOM 列表 -->
    </div>
</div>

<script>
    function loadSBOMs() {
        fetch('/api/sbom')
            .then(response => response.json())
            .then(data => {
                let html = '<table class="table table-bordered"><thead><tr><th>ID</th><th>名称</th><th>格式</th><th>生成时间</th><th>操作</th></tr></thead><tbody>';
                data.forEach(sbom => {
                    html += `<tr>
                        <td>${sbom.id}</td>
                        <td>${sbom.name}</td>
                        <td>${sbom.format}</td>
                        <td>${sbom.generatedAt}</td>
                        <td>
                          <a href="/api/sbom/${sbom.id}/download?format=spdx" class="btn btn-sm btn-info">下载 SPDX</a>
                          <a href="/api/sbom/${sbom.id}/download?format=cyclonedx" class="btn btn-sm btn-success">下载 CycloneDX</a>
                          <a href="/api/sbom/${sbom.id}/download?format=custom" class="btn btn-sm btn-secondary">下载 自定义</a>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('sbomList').innerHTML = html;
            });
    }

    document.getElementById('dirForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/api/sbom/generate/dir', {
            method: 'POST',
            body: formData
        }).then(response => response.json())
            .then(() => loadSBOMs());
    });

    document.getElementById('imageForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/api/sbom/generate/image', {
            method: 'POST',
            body: formData
        }).then(response => response.json())
            .then(() => loadSBOMs());
    });

    loadSBOMs();
</script>
</body>
</html>
